{% extends "base.html" %}

{% block title %}Store - Your PC{% endblock %}

{% block content %}
<h2 style="text-align:center; margin-bottom:12px;">Prebuilt PCs</h2>

<!-- Cart summary at top -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:12px; flex-wrap:wrap;">
  <div>
    <strong>Items in cart:</strong> <span class="cart-count-badge">{{ cart_count }}</span>
  </div>
  <div>
    <strong>Total:</strong> ₹<span id="cart-total">{{ cart_total }}</span>
  </div>
</div>

<div class="prebuild-grid">
  {% for pc in prebuilds %}
  <div class="card" data-pc-id="{{ pc.id }}">
    <img src="{{ url_for('static', filename=pc.image) }}" alt="{{ pc.name }}" style="max-width:100%; height:auto;">
    <div class="card-body">
      <div class="card-title">{{ pc.name }}</div>
      <div class="card-price">₹{{ pc.price }}</div>

      <!-- FULL SPECS -->
      <div style="margin:8px 0;">
        <strong style="font-size:14px;">Specs:</strong>
        <ul style="margin:6px 0 0 18px; color:var(--muted); font-size:14px;">
          {% for s in pc.specs %}
            <li>{{ s }}</li>
          {% endfor %}
        </ul>
      </div>

      <!-- STOCK -->
      {% set stock = pc.get('stock', 0) %}
      <div style="margin-top:8px;">
        {% if stock is not none %}
          {% if stock <= 0 %}
            <strong style="color:#c23;">Sold out</strong>
          {% else %}
            <small>In stock: {{ stock }}</small>
          {% endif %}
        {% endif %}
      </div>

      <!-- Buttons: JS-enabled + no-JS fallback -->
      <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
        <!-- JS-enabled button -->
        <button class="btn small add-btn" data-pc-id="{{ pc.id }}" {% if stock <= 0 %}disabled{% endif %}>＋ Add</button>

        <!-- Remove one unit button (JS) -->
        <button class="btn small remove-one-btn" data-pc-id="{{ pc.id }}" {% if (cart_counts.get(pc.id) or 0) == 0 %}disabled{% endif %}>−</button>

        <!-- Count display -->
        <div class="card-count" style="min-width:34px; text-align:center; font-weight:700;">{{ cart_counts.get(pc.id) or 0 }}</div>

        <!-- No-JS fallback form: submits to server route that redirects to login if needed -->
        <noscript>
          <form method="POST" action="{{ url_for('add_to_cart', pc_id=pc.id) }}" style="display:inline;">
            <button type="submit" class="btn small" style="margin-left:8px;" {% if stock <= 0 %}disabled{% endif %}>Add (no-js)</button>
          </form>
        </noscript>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Proceed button -->
<div style="margin-top:24px; text-align:center;">
  <a id="proceed-btn" href="{% if cart_count > 0 %}{{ url_for('shipping') }}{% else %}#{% endif %}" class="btn" style="padding:12px 24px; font-size:16px; {% if cart_count == 0 %}opacity:.6; pointer-events:none;{% endif %}">
    <span id="proceed-text">{% if cart_count > 0 %}Proceed to Checkout ({{ cart_count }} item{% if cart_count > 1 %}s{% endif %}){% else %}Your cart is empty — add items to proceed{% endif %}</span>
  </a>
</div>

<script>
async function postJson(url) {
  const resp = await fetch(url, {
    method: "POST",
    headers: { "Accept": "application/json" },
    credentials: "same-origin"
  });
  let data;
  try { data = await resp.json(); } catch (e) { data = null; }
  return { status: resp.status, json: data };
}

function updateUI(counts, totalCount, cartTotal) {
  document.querySelectorAll('.cart-count-badge').forEach(el => el.textContent = totalCount);
  const totalEl = document.getElementById('cart-total');
  if (totalEl) totalEl.textContent = cartTotal ?? "0";

  document.querySelectorAll('.card').forEach(card => {
    const id = Number(card.dataset.pcId);
    const count = counts[id] || 0;
    const numElt = card.querySelector('.card-count');
    if (numElt) numElt.textContent = count;
    const removeBtn = card.querySelector('.remove-one-btn');
    if (removeBtn) removeBtn.disabled = count === 0;
  });

  const proceedBtn = document.getElementById('proceed-btn');
  const proceedText = document.getElementById('proceed-text');
  if (totalCount > 0) {
    proceedBtn.href = "{{ url_for('shipping') }}";
    proceedBtn.style.pointerEvents = "";
    proceedBtn.style.opacity = "1";
    proceedText.textContent = `Proceed to Checkout (${totalCount} item${totalCount>1 ? 's' : ''})`;
  } else {
    proceedBtn.href = "#";
    proceedBtn.style.pointerEvents = "none";
    proceedBtn.style.opacity = ".6";
    proceedText.textContent = "Your cart is empty — add items to proceed";
  }
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = btn.dataset.pcId;
      btn.disabled = true;
      const { status, json } = await postJson(`/api/add_to_cart/${id}`);
      btn.disabled = false;

      if (status === 401 || (json && json.error === "not_logged_in")) {
        // redirect to login, preserve return-to
        window.location.href = "{{ url_for('login') }}?next={{ url_for('store') }}";
        return;
      }
      if (json && json.ok) {
        updateUI(json.counts || {}, json.cart_count || 0, json.cart_total || 0);
      } else if (json && json.error === "sold_out") {
        alert("This item is sold out.");
      } else {
        console.error("Add API response:", status, json);
        alert("Could not add item to cart. Please try again or login.");
      }
    });
  });

  document.querySelectorAll('.remove-one-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const id = btn.dataset.pcId;
      btn.disabled = true;
      const { status, json } = await postJson(`/api/remove_one_from_cart/${id}`);
      btn.disabled = false;

      if (status === 401 || (json && json.error === "not_logged_in")) {
        window.location.href = "{{ url_for('login') }}?next={{ url_for('store') }}";
        return;
      }
      if (json && json.ok) {
        updateUI(json.counts || {}, json.cart_count || 0, json.cart_total || 0);
      } else {
        console.error("Remove API response:", status, json);
        alert("Could not remove item. Please try again.");
      }
    });
  });
});
</script>

{% endblock %}
